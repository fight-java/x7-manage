(function(window,angular,undefined){'use strict';function isAOlderThanB(scopeA,scopeB){if(angular.equals(scopeA.length,scopeB.length)){return scopeA>scopeB}else{return scopeA.length>scopeB.length}}function parseStateRef(ref){var parsed=ref.replace(/\n/g," ").match(/^([^(]+?)\s*(\((.*)\))?$/);if(!parsed||parsed.length!==4){throw new Error("Invalid state ref '"+ref+"'");}return{state:parsed[1],paramExpr:parsed[3]||null}}var $registeredListeners={};function registerListenerOnce(tag,$rootScope,event,fn){var deregisterListenerFn=$registeredListeners[tag];if(deregisterListenerFn!==undefined){deregisterListenerFn()}deregisterListenerFn=$rootScope.$on(event,fn);$registeredListeners[tag]=deregisterListenerFn}function $Breadcrumb(){var $$options={prefixStateName:null,template:'bootstrap3',templateUrl:null,templateLast:'default',templateLastUrl:null,includeAbstract:false};this.setOptions=function(options){angular.extend($$options,options)};this.$get=['$state','$stateParams','$rootScope',function($state,$stateParams,$rootScope){var $lastViewScope=$rootScope;registerListenerOnce('$Breadcrumb.$viewContentLoaded',$rootScope,'$viewContentLoaded',function(event){if(!event.targetScope.ncyBreadcrumbIgnore&&isAOlderThanB(event.targetScope.$id,$lastViewScope.$id)){$lastViewScope=event.targetScope}});var $$parentState=function(state){var parent=state.parent||(/^(.+)\.[^.]+$/.exec(state.name)||[])[1];var isObjectParent=typeof parent==="object";return isObjectParent?parent.name:parent};var $$addStateInChain=function(chain,stateRef){var conf,parentParams,ref=parseStateRef(stateRef),force=false,skip=false;for(var i=0,l=chain.length;i<l;i+=1){if(chain[i].name===ref.state){return}}conf=$state.get(ref.state);if(conf.ncyBreadcrumb){if(conf.ncyBreadcrumb.force){force=true}if(conf.ncyBreadcrumb.skip){skip=true}}if((!conf.abstract||$$options.includeAbstract||force)&&!skip){if(ref.paramExpr){parentParams=$lastViewScope.$eval(ref.paramExpr)}conf.ncyBreadcrumbLink=$state.href(ref.state,parentParams||$stateParams||{});conf.ncyBreadcrumbStateRef=stateRef;chain.unshift(conf)}};var $$breadcrumbParentState=function(stateRef){var ref=parseStateRef(stateRef),conf=$state.get(ref.state);if(conf.ncyBreadcrumb&&conf.ncyBreadcrumb.parent){var isFunction=typeof conf.ncyBreadcrumb.parent==='function';var parentStateRef=isFunction?conf.ncyBreadcrumb.parent($lastViewScope):conf.ncyBreadcrumb.parent;if(parentStateRef){return parentStateRef}}return $$parentState(conf)};return{getTemplate:function(templates){if($$options.templateUrl){return null}else if(templates[$$options.template]){return templates[$$options.template]}else{return $$options.template}},getTemplateUrl:function(){return $$options.templateUrl},getTemplateLast:function(templates){if($$options.templateLastUrl){return null}else if(templates[$$options.templateLast]){return templates[$$options.templateLast]}else{return $$options.templateLast}},getTemplateLastUrl:function(){return $$options.templateLastUrl},getStatesChain:function(exitOnFirst){var chain=[];for(var stateRef=$state.$current.self.name;stateRef;stateRef=$$breadcrumbParentState(stateRef)){$$addStateInChain(chain,stateRef);if(exitOnFirst&&chain.length){return chain}}if($$options.prefixStateName){$$addStateInChain(chain,$$options.prefixStateName)}return chain},getLastStep:function(){var chain=this.getStatesChain(true);return chain.length?chain[0]:undefined},$getLastViewScope:function(){return $lastViewScope}}}]}var getExpression=function(interpolationFunction){if(interpolationFunction.expressions){return interpolationFunction.expressions}else{var expressions=[];angular.forEach(interpolationFunction.parts,function(part){if(angular.isFunction(part)){expressions.push(part.exp)}});return expressions}};var registerWatchers=function(labelWatcherArray,interpolationFunction,viewScope,step){angular.forEach(getExpression(interpolationFunction),function(expression){var watcher=viewScope.$watch(expression,function(){step.ncyBreadcrumbLabel=interpolationFunction(viewScope)});labelWatcherArray.push(watcher)})};var deregisterWatchers=function(labelWatcherArray){angular.forEach(labelWatcherArray,function(deregisterWatch){deregisterWatch()})};function BreadcrumbDirective($interpolate,$breadcrumb,$rootScope){var $$templates={bootstrap2:'<ul class="breadcrumb">'+'<li ng-repeat="step in steps" ng-switch="$last || !!step.abstract" ng-class="{active: $last}">'+'<a ng-switch-when="false" href="{{step.ncyBreadcrumbLink}}">{{step.ncyBreadcrumbLabel}}</a>'+'<span ng-switch-when="true">{{step.ncyBreadcrumbLabel}}</span>'+'<span class="divider" ng-hide="$last">/</span>'+'</li>'+'</ul>',bootstrap3:'<ol class="breadcrumb">'+'<li ng-repeat="step in steps" ng-class="{active: $last}" ng-switch="$last || !!step.abstract">'+'<a ng-switch-when="false" href="{{step.ncyBreadcrumbLink}}">{{step.ncyBreadcrumbLabel}}</a>'+'<span ng-switch-when="true">{{step.ncyBreadcrumbLabel}}</span>'+'</li>'+'</ol>'};return{restrict:'AE',replace:true,scope:{},template:$breadcrumb.getTemplate($$templates),templateUrl:$breadcrumb.getTemplateUrl(),link:{post:function postLink(scope){var labelWatchers=[];var renderBreadcrumb=function(){deregisterWatchers(labelWatchers);labelWatchers=[];var viewScope=$breadcrumb.$getLastViewScope();scope.steps=$breadcrumb.getStatesChain();angular.forEach(scope.steps,function(step){if(step.ncyBreadcrumb&&step.ncyBreadcrumb.label){var parseLabel=$interpolate(step.ncyBreadcrumb.label);step.ncyBreadcrumbLabel=parseLabel(viewScope);registerWatchers(labelWatchers,parseLabel,viewScope,step)}else if(step.data&&step.data.pageTitle){step.ncyBreadcrumbLabel=step.data.pageTitle}else{step.ncyBreadcrumbLabel=step.name}});scope.steps.unshift({ncyBreadcrumbLabel:'首页',ncyBreadcrumbLink:'#home'})};registerListenerOnce('BreadcrumbDirective.$viewContentLoaded',$rootScope,'$viewContentLoaded',function(event){if(!event.targetScope.ncyBreadcrumbIgnore){renderBreadcrumb()}});renderBreadcrumb()}}}}BreadcrumbDirective.$inject=['$interpolate','$breadcrumb','$rootScope'];function BreadcrumbLastDirective($interpolate,$breadcrumb,$rootScope){var $$templates={'default':'{{ncyBreadcrumbLabel}}'};return{restrict:'A',scope:{},template:$breadcrumb.getTemplateLast($$templates),templateUrl:$breadcrumb.getTemplateLastUrl(),compile:function(cElement,cAttrs){var template=cElement.attr(cAttrs.$attr.ncyBreadcrumbLast);if(template){cElement.html(template)}return{post:function postLink(scope){var labelWatchers=[];var renderLabel=function(){deregisterWatchers(labelWatchers);labelWatchers=[];var viewScope=$breadcrumb.$getLastViewScope();var lastStep=$breadcrumb.getLastStep();if(lastStep){scope.ncyBreadcrumbLink=lastStep.ncyBreadcrumbLink;if(lastStep.ncyBreadcrumb&&lastStep.ncyBreadcrumb.label){var parseLabel=$interpolate(lastStep.ncyBreadcrumb.label);scope.ncyBreadcrumbLabel=parseLabel(viewScope);registerWatchers(labelWatchers,parseLabel,viewScope,scope)}else{scope.ncyBreadcrumbLabel=lastStep.name}}};registerListenerOnce('BreadcrumbLastDirective.$viewContentLoaded',$rootScope,'$viewContentLoaded',function(event){if(!event.targetScope.ncyBreadcrumbIgnore){renderLabel()}});renderLabel()}}}}}BreadcrumbLastDirective.$inject=['$interpolate','$breadcrumb','$rootScope'];function BreadcrumbTextDirective($interpolate,$breadcrumb,$rootScope){return{restrict:'A',scope:{},template:'{{ncyBreadcrumbChain}}',compile:function(cElement,cAttrs){var template=cElement.attr(cAttrs.$attr.ncyBreadcrumbText);if(template){cElement.html(template)}var separator=cElement.attr(cAttrs.$attr.ncyBreadcrumbTextSeparator)||' / ';return{post:function postLink(scope){var labelWatchers=[];var registerWatchersText=function(labelWatcherArray,interpolationFunction,viewScope){angular.forEach(getExpression(interpolationFunction),function(expression){var watcher=viewScope.$watch(expression,function(newValue,oldValue){if(newValue!==oldValue){renderLabel()}});labelWatcherArray.push(watcher)})};var renderLabel=function(){deregisterWatchers(labelWatchers);labelWatchers=[];var viewScope=$breadcrumb.$getLastViewScope();var steps=$breadcrumb.getStatesChain();var combinedLabels=[];angular.forEach(steps,function(step){if(step.ncyBreadcrumb&&step.ncyBreadcrumb.label){var parseLabel=$interpolate(step.ncyBreadcrumb.label);combinedLabels.push(parseLabel(viewScope));registerWatchersText(labelWatchers,parseLabel,viewScope)}else{combinedLabels.push(step.name)}});scope.ncyBreadcrumbChain=combinedLabels.join(separator)};registerListenerOnce('BreadcrumbTextDirective.$viewContentLoaded',$rootScope,'$viewContentLoaded',function(event){if(!event.targetScope.ncyBreadcrumbIgnore){renderLabel()}});renderLabel()}}}}}BreadcrumbTextDirective.$inject=['$interpolate','$breadcrumb','$rootScope'];angular.module('ncy-angular-breadcrumb',['ui.router.state']).provider('$breadcrumb',$Breadcrumb).directive('ncyBreadcrumb',BreadcrumbDirective).directive('ncyBreadcrumbLast',BreadcrumbLastDirective).directive('ncyBreadcrumbText',BreadcrumbTextDirective)})(window,window.angular);